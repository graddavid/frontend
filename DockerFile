# ---- Build stage ----
FROM node:20-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .

# Override API roots for containerized backends; adjust args if names/ports differ
ARG USER_API=http://user-service:8032
ARG SERVER_API=http://server-service:8031
ARG MEMBERSHIP_API=http://server-service:8031
ARG MESSAGE_API=http://message:8080
ARG PRESENCE_API=http://presence:8081
ARG NOTIFICATION_API=http://notification:8085
ARG INTERNAL_NOTIFICATION_API=http://notification:8085
ARG ENCRYPTION_API=http://encryption:8082
ARG PASSWORD_API=http://encryption:8082
ARG MEDIA_API=http://media:8083
ARG SEARCH_API=http://search:8084
ARG NOTIFICATION_WS=http://notification:8085/ws

# Rewrite production environment to hit the services in compose
RUN node -e "const fs=require('fs');const env={production:true,useMocks:false,apiBaseUrls:{user:'${USER_API}',server:'${SERVER_API}',membership:'${MEMBERSHIP_API}',message:'${MESSAGE_API}',presence:'${PRESENCE_API}',notification:'${NOTIFICATION_API}',internalNotification:'${INTERNAL_NOTIFICATION_API}',encryption:'${ENCRYPTION_API}',password:'${PASSWORD_API}',media:'${MEDIA_API}',search:'${SEARCH_API}'},notificationWs:'${NOTIFICATION_WS}'};fs.writeFileSync('src/environments/environment.prod.ts','export const environment = '+JSON.stringify(env,null,2)+';');"
RUN npm run build -- --configuration production

# ---- Runtime stage ----
FROM node:20-alpine
WORKDIR /app
RUN npm install -g serve
COPY --from=build /app/dist/prpo-chat-frontend ./dist
EXPOSE 80
CMD ["serve", "-s", "dist/prpo-chat-frontend", "-l", "80"]
